<div class="filetree">
	{{#error}}
		<div class="alert alert-danger" role="alert">{{error}}</div>
	{{/error}}
	{{#root}}
	<div class="{{#if .selected}}selected bg-info{{else}}file{{/if}}">
		<span class="icon glyphicon glyphicon-folder-open"></span> 
		{{#if folderOnly}}
			<a href="#"  on-click="select">{{rootDir}}</a>
		{{else}}
			{{rootDir}}
		{{/if}}
	</div>  
		{{>folder}}
	{{/root}}
</div>

<!-- {{>folder}} -->
<ul>
  {{#.files}}
		{{>file}}
  {{/files}}
</ul>
<!-- {{/folder}} -->

<!-- {{>file}} -->
<li>
	<div class="{{#if .selected}}selected bg-info{{else}}file{{/if}}">
		{{#if .isFolder}}
			<a href="#" on-click="open">
				<span class="icon glyphicon glyphicon-{{#if .open}}minus{{else}}plus{{/if}}"></span>
			</a>
			<span class="icon glyphicon glyphicon-folder-close"></span> 
			{{#if folderOnly}}
				<a href="#"  on-click="select">{{name}}</a>
			{{else}}
				<a href="#"  on-click="open">{{name}}</a>
			{{/if}}
		{{else}}
			<span class="icon glyphicon glyphicon-file"></span>
			{{#if folderOnly}}
				{{name}}
			{{else}}
				<a href="#"  on-click="select">{{name}}</a>
			{{/if}}
		{{/if}}
	</div>
	{{#if .isFolder}}
		{{>folder}}
	{{/if}}
</li>
<!-- {{/file}} -->

<style>
	.selected {
		border-color: #ccc;
		border: 0px solid transparent;
		border-radius: 4px;
		padding: 5px;
		font-weight:bold;
	}

	.file {
		padding: 5px;
	}

	.file:hover {
		background-color: #f5f5f5;
		border: 0px solid transparent;
		border-radius: 4px;
	}

	a:hover {
		text-decoration: none;	
		color: #333;
	}

	a {
		color: #333;
	}

	.filetree {
		cursor: default;
		overflow: auto;
	}

	ul {
		list-style: none;
	}

	li {
		margin-left: -22px;
	}

	.icon {
		color: #555;
	}

</style>

<script>
component.exports = {
	data: {
		rootDir: "/v1/file/",
		selected: {},
		root: {
			files: [],
		},
		folderOnly: false,
		filterRegex: ""
	},
	init: function() {
		var r = this;
		r.set("root.url", r.get("rootDir"));

		getFile(r.get("rootDir"), "root");
		
		this.on({
			"open": function(event) {
				if (event.context.isFolder) {
					if (event.context.files) {
						r.set(event.keypath+".open", false);
						r.set(event.keypath+".files", null);	
						return;
					}
					r.set(event.keypath+".open", true);
					getFile(event.context.url, event.keypath);
					return;
				}
			},
			"select": function(event) {
					r.set("root.selected", false);
					clearSelected(r.get("root.files"));
					r.update("root");

					r.set(event.keypath+".selected", true);
					r.set("selected", {
						url: event.context.url,
						name: event.context.name,
						keypath: event.keypath
					});
			},

		});

		function getFile(file, keypath) {
			var regEx;
			try {
					regEx = new RegExp(r.get("filterRegex"), "i");
			} catch (e) {
					regEx = new RegExp("", "i");
			}
			fh.properties.get(file)
				.done(function(result) {
					var files = result.data;

					for (var i = 0; i < files.length;) {
						if (files[i].hasOwnProperty("size")) {
							if (r.get("folderOnly") || (!regEx.exec(files[i].name))) {
								files.splice(i,1);
								continue;
							}
						} else {
							files[i].isFolder = true;
						}
						i++;
					}

					r.set(keypath+".files", files);	
				})
				.fail(function(result) {
					r.set("error", result.message);
				});

		}

		function clearSelected(files) {
			if (!files) {
				return;
			}
			for (var i = 0; i < files.length; i++) {
				files[i].selected = false;	
				if (files[i].hasOwnProperty("files")) {
					clearSelected(files[i].files);
				}
			}
		}
	},

};
</script>
